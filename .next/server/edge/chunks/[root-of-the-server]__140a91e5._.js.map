{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.js"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\n\r\n// อ่านชื่อคุกกี้จาก ENV (คั่นด้วย ,) เช่น NEXT_PUBLIC_AUTH_COOKIES=\"sid,access_token\"\r\nconst ENV_COOKIES = (process.env.NEXT_PUBLIC_AUTH_COOKIES || \"\")\r\n  .split(\",\")\r\n  .map((s) => s.trim())\r\n  .filter(Boolean);\r\n\r\n// fallback ชื่อยอดนิยม (รวม access + refresh)\r\nconst DEFAULT_COOKIES = [\r\n  \"sid\",\r\n  \"access_token\",\r\n  \"accessToken\",\r\n  \"jwt\",\r\n  \"token\",\r\n  \"refresh_token\",\r\n];\r\n\r\n// สุดท้ายใช้ set รวม\r\nconst AUTH_COOKIES = [...new Set([...ENV_COOKIES, ...DEFAULT_COOKIES])];\r\n\r\nfunction hasAnyAuthCookie(req) {\r\n  const cookies = req.cookies;\r\n  if (!cookies) return false;\r\n  for (const name of AUTH_COOKIES) {\r\n    const v = cookies.get(name)?.value;\r\n    if (v && String(v).length > 10) return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction redirectLogin(req) {\r\n  const url = new URL(req.url);\r\n  const to = new URL(\"/login\", req.url); // หน้า login อยู่ /login\r\n  to.searchParams.set(\"redirect\", url.pathname + url.search);\r\n  return NextResponse.redirect(to);\r\n}\r\n\r\nexport function middleware(req) {\r\n  const { pathname } = new URL(req.url);\r\n\r\n  // ข้ามไฟล์สาธารณะ & หน้า auth กันลูป\r\n  if (\r\n    pathname.startsWith(\"/login\") ||\r\n    pathname.startsWith(\"/register\") ||\r\n    pathname.startsWith(\"/forgot-password\") ||\r\n    pathname.startsWith(\"/reset-password\") ||\r\n    pathname.startsWith(\"/_next\") ||\r\n    pathname.startsWith(\"/favicon\") ||\r\n    pathname.startsWith(\"/assets\") ||\r\n    /\\.(png|jpg|jpeg|gif|svg|ico|webp|css|js|map)$/i.test(pathname)\r\n  ) {\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // เส้นทางที่ต้องล็อกอิน (หลังบ้าน)\r\n  const protectedMatchers = [\"/admin\", \"/hr\", \"/approvals\", \"/me\"];\r\n  const needAuth = protectedMatchers.some(\r\n    (p) => pathname === p || pathname.startsWith(p + \"/\")\r\n  );\r\n  if (!needAuth) return NextResponse.next();\r\n\r\n  // เช็คจากคุกกี้อย่างเดียว (Edge ไม่ควร fetch ไป BE)\r\n  if (!hasAnyAuthCookie(req)) {\r\n    if (\r\n      process.env.NODE_ENV !== \"production\" &&\r\n      process.env.NEXT_PUBLIC_ALLOW_NOCOOKIE_DEV === \"1\"\r\n    ) {\r\n      return NextResponse.next();\r\n    }\r\n    return redirectLogin(req);\r\n  }\r\n\r\n  return NextResponse.next();\r\n}\r\n\r\n// ตรวจทุกเส้นทางยกเว้นไฟล์ static/API\r\nexport const config = {\r\n  matcher: [\"/((?!api|_next/static|_next/image|favicon.ico).*)\"],\r\n};\r\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;;AAEA,sFAAsF;AACtF,MAAM,cAAc,CAAC,wDAAwC,EAAE,EAC5D,KAAK,CAAC,KACN,GAAG,CAAC,CAAC,IAAM,EAAE,IAAI,IACjB,MAAM,CAAC;AAEV,8CAA8C;AAC9C,MAAM,kBAAkB;IACtB;IACA;IACA;IACA;IACA;IACA;CACD;AAED,qBAAqB;AACrB,MAAM,eAAe;OAAI,IAAI,IAAI;WAAI;WAAgB;KAAgB;CAAE;AAEvE,SAAS,iBAAiB,GAAG;IAC3B,MAAM,UAAU,IAAI,OAAO;IAC3B,IAAI,CAAC,SAAS,OAAO;IACrB,KAAK,MAAM,QAAQ,aAAc;QAC/B,MAAM,IAAI,QAAQ,GAAG,CAAC,OAAO;QAC7B,IAAI,KAAK,OAAO,GAAG,MAAM,GAAG,IAAI,OAAO;IACzC;IACA,OAAO;AACT;AAEA,SAAS,cAAc,GAAG;IACxB,MAAM,MAAM,IAAI,IAAI,IAAI,GAAG;IAC3B,MAAM,KAAK,IAAI,IAAI,UAAU,IAAI,GAAG,GAAG,yBAAyB;IAChE,GAAG,YAAY,CAAC,GAAG,CAAC,YAAY,IAAI,QAAQ,GAAG,IAAI,MAAM;IACzD,OAAO,gMAAY,CAAC,QAAQ,CAAC;AAC/B;AAEO,SAAS,WAAW,GAAG;IAC5B,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAI,IAAI,IAAI,GAAG;IAEpC,qCAAqC;IACrC,IACE,SAAS,UAAU,CAAC,aACpB,SAAS,UAAU,CAAC,gBACpB,SAAS,UAAU,CAAC,uBACpB,SAAS,UAAU,CAAC,sBACpB,SAAS,UAAU,CAAC,aACpB,SAAS,UAAU,CAAC,eACpB,SAAS,UAAU,CAAC,cACpB,iDAAiD,IAAI,CAAC,WACtD;QACA,OAAO,gMAAY,CAAC,IAAI;IAC1B;IAEA,mCAAmC;IACnC,MAAM,oBAAoB;QAAC;QAAU;QAAO;QAAc;KAAM;IAChE,MAAM,WAAW,kBAAkB,IAAI,CACrC,CAAC,IAAM,aAAa,KAAK,SAAS,UAAU,CAAC,IAAI;IAEnD,IAAI,CAAC,UAAU,OAAO,gMAAY,CAAC,IAAI;IAEvC,oDAAoD;IACpD,IAAI,CAAC,iBAAiB,MAAM;QAC1B,IACE,oDAAyB,gBACzB,QAAQ,GAAG,CAAC,8BAA8B,KAAK,KAC/C;YACA,OAAO,gMAAY,CAAC,IAAI;QAC1B;QACA,OAAO,cAAc;IACvB;IAEA,OAAO,gMAAY,CAAC,IAAI;AAC1B;AAGO,MAAM,SAAS;IACpB,SAAS;QAAC;KAAoD;AAChE"}}]
}